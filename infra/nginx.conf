map $http_x_forwarded_proto $forwarded_proto {
  default $http_x_forwarded_proto;
  ""      $scheme;
}

map $http_x_forwarded_host $forwarded_host {
  default $http_x_forwarded_host;
  ""      $http_host;
}

server {
  listen 80;

  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $forwarded_proto;
  proxy_set_header X-Forwarded-Host $forwarded_host;
  proxy_set_header X-Forwarded-Port $server_port;

  # Main app at /
  location / {
    proxy_pass http://main:80;
  }

  # Landing at /landing/  (strip prefix)
  location ^~ /landing/ {
    rewrite ^/landing/(.*)$ /$1 break;
    proxy_pass http://landing:80;
  }

  # API
  location ^~ /api/ {
    proxy_pass http://backend:8080;
  }
}
